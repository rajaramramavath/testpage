<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <script type="module">
    // ✅ Import Firebase from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 🔑 Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBEfI4QzJU2kc2PEp02x36BftvO6P5qJps",
      authDomain: "admindemon-b3823.firebaseapp.com",
      databaseURL: "https://admindemon-b3823-default-rtdb.firebaseio.com",
      projectId: "admindemon-b3823",
      storageBucket: "admindemon-b3823.appspot.com",
      messagingSenderId: "33424574422",
      appId: "1:33424574422:web:96db3c6388d89d162c4677",
      measurementId: "G-188H3B2LSZ"
    };

    // ✅ Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ----------------- LOGIN -----------------
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        console.log("✅ Logged in:", userCred.user.email);
      } catch (err) {
        console.error("❌ Login failed:", err);
        alert("Login failed: " + err.message);
      }
    }

    function logout() {
      signOut(auth).then(() => {
        console.log("✅ Logged out");
      });
    }

    // ----------------- SECTIONS -----------------
    async function loadSections() {
      const select = document.getElementById("sectionSelect");
      select.innerHTML = "<option value=''>Select Section</option>";
      try {
        const snapshot = await getDocs(collection(db, "sections"));
        snapshot.forEach(docSnap => {
          const opt = document.createElement("option");
          opt.value = docSnap.id;
          opt.textContent = docSnap.data().name;
          select.appendChild(opt);
        });
        console.log("✅ Sections loaded:", snapshot.size);
      } catch (err) {
        console.error("❌ Error loading sections:", err);
      }
    }

    async function createSection() {
      const name = document.getElementById("newSection").value;
      if (!name) return alert("Enter section name");
      try {
        await addDoc(collection(db, "sections"), { name, subjects: {} });
        document.getElementById("newSection").value = "";
        alert("✅ Section created!");
        console.log("✅ Section created:", name);
        loadSections();
      } catch (err) {
        console.error("❌ Error creating section:", err);
        alert("Error creating section: " + err.message);
      }
    }

    async function deleteSection() {
      const id = document.getElementById("sectionSelect").value;
      if (!id) return alert("Select section");
      try {
        await deleteDoc(doc(db, "sections", id));
        alert("✅ Section deleted");
        console.log("✅ Section deleted:", id);
        loadSections();
      } catch (err) {
        console.error("❌ Error deleting section:", err);
        alert("Error deleting section: " + err.message);
      }
    }

    // ----------------- SUBJECTS -----------------
    async function addSubject() {
      const id = document.getElementById("sectionSelect").value;
      const day = document.getElementById("day").value;
      const name = document.getElementById("subjectName").value;
      const time = document.getElementById("subjectTime").value;

      if (!id || !day || !name || !time) return alert("Fill all fields");

      try {
        const snapshot = await getDocs(collection(db, "sections"));
        const sectionDoc = snapshot.docs.find(d => d.id === id);
        const data = sectionDoc.data();

        if (!data.subjects) data.subjects = {};
        if (!data.subjects[day]) data.subjects[day] = [];
        data.subjects[day].push({ name, time });

        await updateDoc(doc(db, "sections", id), { subjects: data.subjects });
        alert("✅ Subject added");
        console.log("✅ Subject added:", { name, time, day });
        document.getElementById("subjectName").value = "";
        document.getElementById("subjectTime").value = "";
      } catch (err) {
        console.error("❌ Error adding subject:", err);
        alert("Error adding subject: " + err.message);
      }
    }

    async function deleteSubject() {
      const id = document.getElementById("sectionSelect").value;
      const day = document.getElementById("day").value;
      const name = document.getElementById("subjectName").value;

      if (!id || !day || !name) return alert("Fill all fields");

      try {
        const snapshot = await getDocs(collection(db, "sections"));
        const sectionDoc = snapshot.docs.find(d => d.id === id);
        const data = sectionDoc.data();

        if (!data.subjects || !data.subjects[day]) {
          alert("❌ No subjects found for this day");
          return;
        }

        data.subjects[day] = data.subjects[day].filter(s => s.name !== name);

        await updateDoc(doc(db, "sections", id), { subjects: data.subjects });
        alert("✅ Subject deleted");
        console.log("✅ Subject deleted:", { name, day });
        document.getElementById("subjectName").value = "";
      } catch (err) {
        console.error("❌ Error deleting subject:", err);
        alert("Error deleting subject: " + err.message);
      }
    }

    // ----------------- AUTH STATE -----------------
    onAuthStateChanged(auth, user => {
      if (user) {
        console.log("👤 Logged in user:", user.email);
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadSections();
      } else {
        console.log("👤 No user logged in");
        document.getElementById("loginForm").style.display = "block";
        document.getElementById("adminPanel").style.display = "none";
      }
    });

    // Expose functions to HTML
    window.login = login;
    window.logout = logout;
    window.createSection = createSection;
    window.deleteSection = deleteSection;
    window.addSubject = addSubject;
    window.deleteSubject = deleteSubject;
  </script>
</head>
<body>
  <h1>Admin Panel</h1>

  <!-- Login Form -->
  <div id="loginForm">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminPanel" style="display:none;">
    <button onclick="logout()">Logout</button>

    <h2>Sections</h2>
    <input id="newSection" placeholder="New Section Name">
    <button onclick="createSection()">Create Section</button>
    <br><br>
    <select id="sectionSelect"></select>
    <button onclick="deleteSection()">Delete Section</button>

    <h2>Subjects</h2>
    <input id="subjectName" placeholder="Subject Name"><br>
    <input id="subjectTime" placeholder="Time (e.g. 10:00 AM)"><br>
    <select id="day">
      <option value="">Select Day</option>
      <option>Monday</option>
      <option>Tuesday</option>
      <option>Wednesday</option>
      <option>Thursday</option>
      <option>Friday</option>
      <option>Saturday</option>
    </select><br>
    <button onclick="addSubject()">Add Subject</button>
    <button onclick="deleteSubject()">Delete Subject</button>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <script type="module">
    // âœ… Import Firebase from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ðŸ”‘ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBEfI4QzJU2kc2PEp02x36BftvO6P5qJps",
      authDomain: "admindemon-b3823.firebaseapp.com",
      databaseURL: "https://admindemon-b3823-default-rtdb.firebaseio.com",
      projectId: "admindemon-b3823",
      storageBucket: "admindemon-b3823.appspot.com",
      messagingSenderId: "33424574422",
      appId: "1:33424574422:web:96db3c6388d89d162c4677",
      measurementId: "G-188H3B2LSZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    }

    function logout() {
      signOut(auth);
    }

    async function loadSections() {
      const select = document.getElementById("sectionSelect");
      select.innerHTML = "<option value=''>Select Section</option>";
      const snapshot = await getDocs(collection(db, "sections"));
      snapshot.forEach(docSnap => {
        const opt = document.createElement("option");
        opt.value = docSnap.id;
        opt.textContent = docSnap.data().name;
        select.appendChild(opt);
      });
    }

    async function createSection() {
      const name = document.getElementById("newSection").value;
      if (!name) return alert("Enter section name");
      await addDoc(collection(db, "sections"), { name, subjects: {} });
      document.getElementById("newSection").value = "";
      loadSections();
    }

    async function deleteSection() {
      const id = document.getElementById("sectionSelect").value;
      if (!id) return alert("Select section");
      await deleteDoc(doc(db, "sections", id));
      loadSections();
    }

    async function addSubject() {
      const id = document.getElementById("sectionSelect").value;
      const day = document.getElementById("day").value;
      const name = document.getElementById("subjectName").value;
      const time = document.getElementById("subjectTime").value;

      if (!id || !day || !name || !time) return alert("Fill all fields");

      // Fetch current data
      const snapshot = await getDocs(collection(db, "sections"));
      const sectionDoc = snapshot.docs.find(d => d.id === id);
      const data = sectionDoc.data();

      if (!data.subjects) data.subjects = {};
      if (!data.subjects[day]) data.subjects[day] = [];
      data.subjects[day].push({ name, time });

      await updateDoc(doc(db, "sections", id), { subjects: data.subjects });

      alert("Subject added");
      document.getElementById("subjectName").value = "";
      document.getElementById("subjectTime").value = "";
    }

    async function deleteSubject() {
      const id = document.getElementById("sectionSelect").value;
      const day = document.getElementById("day").value;
      const name = document.getElementById("subjectName").value;

      if (!id || !day || !name) return alert("Fill all fields");

      const snapshot = await getDocs(collection(db, "sections"));
      const sectionDoc = snapshot.docs.find(d => d.id === id);
      const data = sectionDoc.data();

      if (!data.subjects || !data.subjects[day]) return alert("No subjects found");

      data.subjects[day] = data.subjects[day].filter(s => s.name !== name);

      await updateDoc(doc(db, "sections", id), { subjects: data.subjects });

      alert("Subject deleted");
      document.getElementById("subjectName").value = "";
    }

    // Handle login state
    onAuthStateChanged(auth, user => {
      document.getElementById("loginForm").style.display = user ? "none" : "block";
      document.getElementById("adminPanel").style.display = user ? "block" : "none";
      if (user) loadSections();
    });

    // Expose to window
    window.login = login;
    window.logout = logout;
    window.createSection = createSection;
    window.deleteSection = deleteSection;
    window.addSubject = addSubject;
    window.deleteSubject = deleteSubject;
  </script>
</head>
<body>
  <h1>Admin Panel</h1>

  <!-- Login Form -->
  <div id="loginForm">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminPanel" style="display:none;">
    <button onclick="logout()">Logout</button>

    <h2>Sections</h2>
    <input id="newSection" placeholder="New Section Name">
    <button onclick="createSection()">Create Section</button>
    <br><br>
    <select id="sectionSelect"></select>
    <button onclick="deleteSection()">Delete Section</button>

    <h2>Subjects</h2>
    <input id="subjectName" placeholder="Subject Name"><br>
    <input id="subjectTime" placeholder="Time (e.g. 10:00 AM)"><br>
    <select id="day">
      <option value="">Select Day</option>
      <option>Monday</option>
      <option>Tuesday</option>
      <option>Wednesday</option>
      <option>Thursday</option>
      <option>Friday</option>
      <option>Saturday</option>
    </select><br>
    <button onclick="addSubject()">Add Subject</button>
    <button onclick="deleteSubject()">Delete Subject</button>
  </div>
</body>
</html>
